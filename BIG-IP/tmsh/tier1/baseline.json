{
  "mgmt-baseline": {
    "commands": {
        "084-apply-mgmt-baseline": { 
            "test" : "[ -f /config/deployBaseline.sh ]",
            "command": { 
               "Fn::Join": [  
                " ", 
                [ 
                 "nohup /config/waitThenRun.sh",
                 "f5-rest-node /config/cloud/aws/node_modules/@f5devcentral/f5-cloud-libs/scripts/runScript.js",
                 "--file /config/deployBaseline.sh",
                 "--output /var/log/deployBaseline.log",
                 "--log-level silly",
                 "--wait-for CERTS_DONE",
                 "--signal MGMT_DONE",
                 "&>> /var/log/cloud/aws/install.log < /dev/null &"
                ] 
               ] 
          }, 
          "cwd" : "/config"  
          } 
          
    },
    "files": {
        "/config/mgmt.tcl": {
          "group": "root",
          "mode": "000755",
          "owner": "root",
          "content": {
              "Fn::Join": [
                  "",
                  [
                  "#!/bin/bash\n",
                  "declarationUrlrouting='",
                  {
                  "Ref": "declarationUrlrouting"
                  },
                  "'\n",
                  "VIP1='",
                  {
                  "Fn::GetAtt": [
                  "Bigip1subnet1Az1Interface",
                  "PrimaryPrivateIpAddress"
                  ]
                  },
                  "'\n",
                  "VIP2='",
                  {
                  "Fn::GetAtt": [
                  "Bigip2subnet1Az1Interface",
                  "PrimaryPrivateIpAddress"
                  ]
                  },
                  "'\n",
                  "JUMPHOSTIP='",
                  {
                  "Ref": "pJumpHostPrivateIP"
                  },
                  "'\n",
                  "\n",
                  "### FILE CREATION FOR MGMT ACCESS\n",
                  "file_loc=\"./mgmt.tcl\"\n",
                  "  sed -i 's/ReplaceWithJumpHostIP/'\"$JUMPHOSTIP\"'/g' $file_loc\n",
                  "  sed -i 's/ReplaceWithVIP1/'\"$VIP1\"'/g' $file_loc\n",
                  "\n",
                  "### END DEPLOYMENT OF FILE CREATION FOR MGMT ACCESS"
                  ]
              ]
          }
      },  
      "/config/delete.tcl": {
          "group": "root",
          "mode": "000755",
          "owner": "root",
          "content": {
              "Fn::Join": [
                  "",
                  [
                  "#!/bin/bash\n",
                  "declarationUrlrouting='",
                  {
                  "Ref": "declarationUrlrouting"
                  },
                  "'\n",
                  "VIP1='",
                  {
                  "Fn::GetAtt": [
                  "Bigip1subnet1Az1Interface",
                  "PrimaryPrivateIpAddress"
                  ]
                  },
                  "'\n",
                  "VIP2='",
                  {
                  "Fn::GetAtt": [
                  "Bigip2subnet1Az1Interface",
                  "PrimaryPrivateIpAddress"
                  ]
                  },
                  "'\n",
                  "JUMPHOSTIP='",
                  {
                  "Ref": "pJumpHostPrivateIP"
                  },
                  "'\n",
                  "\n",
                  "### FILE CREATION FOR MGMT ACCESS\n",
                  "file_loc=\"./delete.tcl\"\n",
                  "  sed -i 's/ReplaceWithJumpHostIP/'\"$JUMPHOSTIP\"'/g' $file_loc\n",
                  "  sed -i 's/ReplaceWithVIP1/'\"$VIP1\"'/g' $file_loc\n",
                  "\n",
                  "### END DEPLOYMENT OF FILE CREATION FOR MGMT ACCESS"
                  ]
              ]
          }
      },
      "/config/deployBaseline.sh": {
          "group": "root",
          "mode": "000755",
          "owner": "root",
          "content": {
              "Fn::Join": [
                  "",
                  [
                  "#!/bin/bash\n",
                  "# bash ./baseline.sh \"tmsh run cli script file ./mgmt.tcl\"",
                  "# bash ./baseline.sh \"tmsh run cli script file ./delete.tcl\"",
                  "### START DEPLOYMENT FOR MGMT ACCESS\n",
                  "command=\"tmsh run cli script file ./mgmt.tcl\"",
                  "if [[ $($command) ]]; then\n",
                  "    echo \"mgmt deployment failed\"\n",
                  "else\n",
                  "   echo \"mgmt deployment successful\"\n",
                  "fi\n",
                  "'\n",
                  "\n",
                  "### END DEPLOYMENT OF AS3 DECLARATION FOR MGMT ACCESS"
                  ]
              ]
          }
      }   
    }
  }
}